<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<h2>State</h2>
<p>ICE Connection state: <span id="ice-connection-state"></span></p>
<p>ICE Gathering state: <span id="ice-gathering-state"></span></p>
<p>Signaling state: <span id="signaling-state"></span></p>

<p>Please enter the offer provided to you by the sender application: </p>
<label>
    <textarea cols="80" rows="25"></textarea>
</label>
<button>Submit</button>

<audio id="audio-element" autoplay playsinline></audio>
<script>
    const iceConnectionLog = document.getElementById('ice-connection-state'),
        iceGatheringLog = document.getElementById('ice-gathering-state'),
        signalingLog = document.getElementById('signaling-state');

    document.querySelector('button').addEventListener('click',  async () => {
        const offer = JSON.parse(document.querySelector('textarea').value.replaceAll("\n", ""));
        const pc = new RTCPeerConnection({
            bundlePolicy: 'max-bundle',
        });

        pc.addEventListener('iceconnectionstatechange', () =>
            iceConnectionLog.textContent += ' -> ' + pc.iceConnectionState);
        iceConnectionLog.textContent = pc.iceConnectionState;

        pc.onicegatheringstatechange = (state) => {
            iceGatheringLog.textContent += ' -> ' + pc.iceGatheringState;
            if (pc.iceGatheringState === 'complete') {
                // We only want to provide an answer once all of our candidates have been added to the SDP.
                const answer = pc.localDescription;
                document.querySelector('textarea').value = JSON.stringify({"type": answer.type, sdp: answer.sdp});
                document.querySelector('p').value = 'Please paste the answer in the sender application.';
                alert('Please paste the answer in the sender application.');
            }
        }
        iceGatheringLog.textContent = pc.iceGatheringState;

        pc.addEventListener('signalingstatechange', () =>
            signalingLog.textContent += ' -> ' + pc.signalingState);
        signalingLog.textContent = pc.signalingState;

        pc.ontrack = (evt) => {
            console.log("TEST", evt);
            const audioElement = document.getElementById('audio-element');
            audioElement.srcObject = evt.streams[0];
            audioElement.play();
        };

        await pc.setRemoteDescription(offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
    })

    function extractParamsFromSDP(sdpInput) {
        const lines = sdpInput.split("\r\n");
        const transport = {
            candidates: [],
            xmlns: "urn:xmpp:jingle:transports:ice-udp:1",
        };

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            console.log(line);
            if (line.startsWith("a=ice-ufrag")) {
                transport.ufrag = line.split(":")[1];
            } else if (line.startsWith("a=ice-pwd")) {
                transport.pwd = line.split(":")[1];
            } else if (line.startsWith("a=candidate")) {
                const parts = line.split(":")[1].split(" ");
                const candidate = {
                    generation: parts[9],
                    component: parts[1],
                    protocol: parts[2],
                    port: parts[5],
                    ip: parts[4],
                    foundation: parts[0],
                    id: parts[0],
                    priority: parts[3],
                    type: parts[7],
                    network: "999",
                };
                transport.candidates.push(candidate);
            } else if (line.startsWith("a=fingerprint")) {
                const parts = line.split(" ");
                const fingerprint = {
                    fingerprint: parts[1],
                    setup: lines[i+1].split(":")[1],
                    hash: parts[0].split(":")[1] ,
                };
                transport.fingerprints = [fingerprint];
            }
        }
        return {transport};
    }

</script>
</body>
</html>
